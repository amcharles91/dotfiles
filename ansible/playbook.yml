---
- name: Setup Development Environment
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    # User configuration (mirrors chezmoi config)
    user_name: "{{ ansible_env.USER }}"
    
    # Common PATH entries for all shells
    path_entries:
      - "$HOME/.local/bin"
      - "$HOME/.cargo/bin"
    
    # APT packages to install
    apt_packages:
      - build-essential
      - curl
      - wget
      - git
      - unzip
      - jq
      - htop
      - tree
      - software-properties-common
      - ca-certificates
      - gnupg
      - lsb-release
      - fish
      - ripgrep
      - bat
      - fd-find
    
    # Cargo tools to install
    cargo_tools:
      - name: starship
        binary: starship
      - name: cargo-binstall
        binary: cargo-binstall
      - name: cargo-update
        binary: cargo-install-update
    
    # Additional cargo tools to install via binstall
    cargo_binstall_tools:
      - name: fnm
        binary: fnm
      - name: eza
        binary: eza

  tasks:
    # System packages
    - name: Update apt cache and install system packages
      become: yes
      apt:
        name: "{{ apt_packages }}"
        state: present
        update_cache: yes
        cache_valid_time: 3600

    # Symlinks for renamed packages
    - name: Create symlinks for bat and fd
      become: yes
      file:
        src: "/usr/bin/{{ item.src }}"
        dest: "/usr/local/bin/{{ item.dest }}"
        state: link
      loop:
        - { src: 'batcat', dest: 'bat' }
        - { src: 'fdfind', dest: 'fd' }
      ignore_errors: yes

    # Nushell installation (not in default repos)
    - name: Check if nushell is installed
      command: which nu
      register: nu_check
      failed_when: false
      changed_when: false

    - name: Install nushell from GitHub releases
      when: nu_check.rc != 0
      block:
        - name: Get latest nushell version
          uri:
            url: https://api.github.com/repos/nushell/nushell/releases/latest
            return_content: yes
          register: nu_release

        - name: Set nushell version
          set_fact:
            nu_version: "{{ nu_release.json.tag_name }}"

        - name: Download and install nushell
          unarchive:
            src: "https://github.com/nushell/nushell/releases/download/{{ nu_version }}/nu-{{ nu_version }}-x86_64-unknown-linux-musl.tar.gz"
            dest: "/tmp"
            remote_src: yes
            creates: "/tmp/nu-{{ nu_version }}-x86_64-unknown-linux-musl/nu"

        - name: Install nushell binary
          become: yes
          copy:
            src: "/tmp/nu-{{ nu_version }}-x86_64-unknown-linux-musl/nu"
            dest: "/usr/local/bin/nu"
            mode: '0755'
            remote_src: yes

    # Rust installation
    - name: Install Rust
      include_role:
        name: gantsign.rust

    # Cargo tools installation
    - name: Install cargo tools
      command: "{{ ansible_env.HOME }}/.cargo/bin/cargo install {{ item.name }}"
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/{{ item.binary }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
      loop: "{{ cargo_tools }}"

    # Install additional tools via cargo-binstall
    - name: Install tools via cargo-binstall
      command: "{{ ansible_env.HOME }}/.cargo/bin/cargo-binstall -y {{ item.name }}"
      args:
        creates: "{{ ansible_env.HOME }}/.cargo/bin/{{ item.binary }}"
      environment:
        PATH: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
      loop: "{{ cargo_binstall_tools }}"

    # Create directories
    - name: Ensure required directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ ansible_env.HOME }}/.local/bin"
        - "{{ ansible_env.HOME }}/.config"
        - "{{ ansible_env.HOME }}/.config/fish"
        - "{{ ansible_env.HOME }}/.config/nushell"
        - "{{ ansible_env.HOME }}/.config/ansible_generated"

    # Generate shell configuration snippets
    - name: Generate bash configuration snippet
      template:
        src: templates/common.bash
        dest: "{{ ansible_env.HOME }}/.config/ansible_generated/common.bash"
        mode: '0644'

    - name: Generate fish configuration snippet
      template:
        src: templates/common.fish
        dest: "{{ ansible_env.HOME }}/.config/ansible_generated/common.fish"
        mode: '0644'

    - name: Generate nushell configuration snippet
      template:
        src: templates/common.nu
        dest: "{{ ansible_env.HOME }}/.config/ansible_generated/common.nu"
        mode: '0644'

    # Fonts
    - name: Create fonts directory
      file:
        path: "{{ ansible_env.HOME }}/.local/share/fonts"
        state: directory
        mode: '0755'

    - name: Check if JetBrainsMono font is installed
      stat:
        path: "{{ ansible_env.HOME }}/.local/share/fonts/JetBrainsMonoNerdFont-Regular.ttf"
      register: font_check

    - name: Download and install JetBrainsMono Nerd Font
      when: not font_check.stat.exists
      block:
        - name: Download JetBrainsMono Nerd Font
          unarchive:
            src: https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip
            dest: "{{ ansible_env.HOME }}/.local/share/fonts"
            remote_src: yes

        - name: Update font cache
          command: fc-cache -f -v