#!/bin/bash
# Simplified installation script for chezmoi dotfiles
set -uo pipefail  # Remove -e to continue on errors

echo "ğŸš€ Setting up development environment..."

# Function to detect OS
detect_os() {
    case "$(uname -s)" in
        Linux*)     echo "linux";;
        Darwin*)    echo "macos";;
        MINGW*|MSYS*|CYGWIN*) echo "windows";;
        *)          echo "unknown";;
    esac
}

# Function to detect package manager
detect_package_manager() {
    if command -v apt-get &> /dev/null; then
        echo "apt"
    elif command -v dnf &> /dev/null; then
        echo "dnf"
    elif command -v pacman &> /dev/null; then
        echo "pacman"
    elif command -v brew &> /dev/null; then
        echo "brew"
    elif command -v winget &> /dev/null; then
        echo "winget"
    else
        echo "none"
    fi
}

OS_TYPE=$(detect_os)
PKG_MGR=$(detect_package_manager)

echo "Detected OS: $OS_TYPE"
echo "Detected package manager: $PKG_MGR"

# Install Starship
if ! command -v starship &> /dev/null; then
    echo "ğŸ“¦ Installing Starship..."
    
    if [[ "$OS_TYPE" == "windows" ]] && [[ "$PKG_MGR" == "winget" ]]; then
        winget install --id Starship.Starship -e --silent --accept-package-agreements --accept-source-agreements
    else
        # Use official installer for all other platforms
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    fi
    
    echo "âœ… Starship installed"
else
    echo "âœ… Starship already installed"
fi

# Install Nushell
if ! command -v nu &> /dev/null; then
    echo "ğŸ“¦ Installing Nushell..."
    
    case "$PKG_MGR" in
        apt)
            # Try snap if available (Ubuntu/Debian with snapd)
            if command -v snap &> /dev/null; then
                echo "  ğŸ“¦ Installing Nushell via snap..."
                sudo snap install nushell --classic || echo "  âš ï¸  Failed to install Nushell via snap"
            else
                echo "  â„¹ï¸  Nushell not in default apt repos and snap not available"
                echo "  ğŸ“ To install: https://www.nushell.sh/book/installation.html#ubuntu-debian"
            fi
            ;;
        dnf)
            sudo dnf install -y nushell
            ;;
        pacman)
            sudo pacman -S --noconfirm nushell
            ;;
        brew)
            brew install nushell
            ;;
        winget)
            winget install --id Nushell.Nushell -e --silent --accept-package-agreements --accept-source-agreements
            ;;
        *)
            echo "âš ï¸  Please install Nushell manually from https://www.nushell.sh/"
            ;;
    esac
else
    echo "âœ… Nushell already installed"
fi

# Install Fish (not on Windows)
if [[ "$OS_TYPE" != "windows" ]] && ! command -v fish &> /dev/null; then
    echo "ğŸ“¦ Installing Fish shell..."
    
    case "$PKG_MGR" in
        apt)
            # Fish is in universe repository
            sudo apt-get update -qq
            sudo apt-get install -y fish || echo "  âš ï¸  Fish not available, may need 'sudo add-apt-repository universe'"
            ;;
        dnf)
            sudo dnf install -y fish
            ;;
        pacman)
            sudo pacman -S --noconfirm fish
            ;;
        brew)
            brew install fish
            ;;
        *)
            echo "âš ï¸  Please install Fish manually"
            ;;
    esac
else
    echo "âœ… Fish already installed or not applicable for this OS"
fi

# Install JetBrains Mono Nerd Font
echo "ğŸ“¦ Checking JetBrains Mono Nerd Font..."

install_nerd_font() {
    local FONT_NAME="JetBrainsMono"
    local FONT_URL="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/${FONT_NAME}.zip"
    
    case "$OS_TYPE" in
        linux|macos)
            # Check if font is already installed
            if fc-list | grep -qi "JetBrainsMono.*Nerd"; then
                echo "âœ… JetBrains Mono Nerd Font already installed"
                return
            fi
            
            # Ensure unzip is available
            if ! command -v unzip &> /dev/null; then
                echo "  ğŸ“¦ Installing unzip..."
                case "$PKG_MGR" in
                    apt) sudo apt-get install -y unzip ;;
                    dnf) sudo dnf install -y unzip ;;
                    pacman) sudo pacman -S --noconfirm unzip ;;
                    brew) brew install unzip ;;
                esac
            fi
            
            # Download and install
            local FONT_DIR="$HOME/.local/share/fonts"
            [[ "$OS_TYPE" == "macos" ]] && FONT_DIR="$HOME/Library/Fonts"
            
            mkdir -p "$FONT_DIR"
            local TEMP_DIR=$(mktemp -d)
            
            echo "  Downloading font..."
            curl -sL "$FONT_URL" -o "$TEMP_DIR/font.zip"
            unzip -q "$TEMP_DIR/font.zip" -d "$TEMP_DIR"
            
            # Copy only the font files we need
            find "$TEMP_DIR" -name "*.ttf" -o -name "*.otf" | \
                grep -E "(Regular|Bold|Italic|BoldItalic)" | \
                xargs -I {} cp {} "$FONT_DIR/"
            
            # Update font cache
            if [[ "$OS_TYPE" == "linux" ]]; then
                fc-cache -f
                echo "  Font cache updated"
            fi
            
            rm -rf "$TEMP_DIR"
            echo "âœ… JetBrains Mono Nerd Font installed"
            ;;
            
        windows)
            if [[ "$PKG_MGR" == "winget" ]]; then
                winget install --id DEVCOM.JetBrainsMonoNerdFont -e --silent --accept-package-agreements --accept-source-agreements || {
                    echo "âš ï¸  Please install JetBrains Mono Nerd Font manually from:"
                    echo "    https://github.com/ryanoasis/nerd-fonts/releases"
                }
            else
                echo "âš ï¸  Please install JetBrains Mono Nerd Font manually"
            fi
            ;;
    esac
}

install_nerd_font

# Final setup message
echo ""
# Install modern CLI tools
echo "ğŸ“¦ Installing modern CLI tools..."

install_cli_tools() {
    echo "ğŸ”§ Attempting to install developer tools..."
    
    case "$PKG_MGR" in
        apt)
            sudo apt-get update -qq
            # Install available tools, continue if some fail
            for tool in bat ripgrep fd-find git-delta lsd; do
                if ! sudo apt-get install -y "$tool" 2>/dev/null; then
                    # Try snap as fallback
                    if command -v snap &> /dev/null; then
                        case "$tool" in
                            bat) sudo snap install batcat --classic && sudo snap alias batcat bat ;;
                            ripgrep) sudo snap install ripgrep --classic ;;
                            fd-find) sudo snap install fd --classic ;;
                            git-delta) echo "  â„¹ï¸  git-delta not available in snap" ;;
                            lsd) sudo snap install lsd --classic ;;
                        esac || echo "  âš ï¸  $tool not available in apt or snap"
                    else
                        echo "  âš ï¸  $tool not available in apt"
                    fi
                fi
            done
            ;;
        dnf)
            for tool in bat ripgrep fd-find git-delta lsd; do
                sudo dnf install -y "$tool" 2>/dev/null || echo "  âš ï¸  $tool not available in dnf"
            done
            ;;
        pacman)
            for tool in bat ripgrep fd lsd; do
                sudo pacman -S --noconfirm "$tool" 2>/dev/null || echo "  âš ï¸  $tool not available in pacman"
            done
            ;;
        brew)
            brew install bat ripgrep fd git-delta lsd || true
            ;;
        *)
            echo "âš ï¸  No supported package manager found"
            echo "   Please install these tools manually:"
            echo "   - bat: https://github.com/sharkdp/bat"
            echo "   - ripgrep: https://github.com/BurntSushi/ripgrep"
            echo "   - fd: https://github.com/sharkdp/fd"
            echo "   - delta: https://github.com/dandavison/delta"
            echo "   - lsd: https://github.com/lsd-rs/lsd"
            return
            ;;
    esac
    
    echo "âœ… CLI tools installation attempted"
    echo "   Run 'bat --version' etc. to verify what's installed"
}

# Only install if package manager is available
if [[ "$PKG_MGR" != "none" ]] && [[ "$PKG_MGR" != "winget" ]]; then
    install_cli_tools
fi

# Configure Starship for Nushell if it's installed
if command -v nu &> /dev/null && command -v starship &> /dev/null; then
    echo "ğŸš€ Configuring Starship for Nushell..."
    
    # Get Nushell data directory
    NU_DATA_DIR=$(nu -c 'echo $nu.data-dir')
    
    # Create vendor/autoload directory
    mkdir -p "$NU_DATA_DIR/vendor/autoload"
    
    # Generate Starship init script for Nushell
    starship init nu > "$NU_DATA_DIR/vendor/autoload/starship.nu"
    
    echo "âœ… Starship configured for Nushell"
fi

# Create convenience aliases for tools with different names
if [[ "$PKG_MGR" == "apt" ]]; then
    echo "ğŸ“ Setting up command aliases..."
    
    # Create local bin directory if it doesn't exist
    mkdir -p "$HOME/.local/bin"
    
    # Create fd alias for fd-find
    if command -v fd-find &> /dev/null && ! command -v fd &> /dev/null; then
        ln -sf $(which fd-find) "$HOME/.local/bin/fd"
        echo "  Created alias: fd -> fd-find"
    fi
    
    # Create nu alias for nushell if installed via snap
    if snap list 2>/dev/null | grep -q nushell && ! command -v nu &> /dev/null; then
        ln -sf /snap/bin/nu "$HOME/.local/bin/nu"
        echo "  Created alias: nu -> /snap/bin/nu"
    fi
    
    # batcat is already handled by the package itself on newer Ubuntu
fi

echo "âœ¨ Installation complete!"
echo ""
echo "ğŸ“ Next steps:"
echo "1. Run 'chezmoi apply' to apply the configuration"
echo "2. Restart your terminal or source your shell config"
echo ""

# OS-specific notes
case "$OS_TYPE" in
    windows)
        echo "ğŸ’¡ Windows notes:"
        echo "- Fish shell is not available on Windows (use WSL if needed)"
        echo "- Make sure to restart Windows Terminal after font installation"
        ;;
    macos)
        echo "ğŸ’¡ macOS notes:"
        echo "- You may need to select JetBrainsMono Nerd Font in Terminal preferences"
        ;;
    linux)
        echo "ğŸ’¡ Linux notes:"
        echo "- You may need to select JetBrainsMono Nerd Font in your terminal emulator"
        ;;
esac
