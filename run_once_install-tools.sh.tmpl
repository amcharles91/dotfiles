{{ if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
# Install JetBrains Mono, Starship, Fish & Nushell (Nushell becomes login shell
# unless KEEP_CURRENT_SHELL=1). Works with and without sudo.
set -euo pipefail

# â”€â”€ root/sudo detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ $EUID -eq 0 ]]; then
  SUDO=""                         # already root (Docker, root shell)
else
  command -v sudo >/dev/null || { echo "âŒ sudo required"; exit 1; }
  SUDO="sudo"
fi

# â”€â”€ cross-distro package helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
install_pkg() {
  if command -v apt-get &>/dev/null; then
    [[ -z "${APT_UPDATED:-}" ]] && { $SUDO apt-get update -qq; APT_UPDATED=1; }
    $SUDO apt-get install -y --no-install-recommends "$@"
  elif command -v dnf &>/dev/null;   then $SUDO dnf    install -y "$@"
  elif command -v pacman &>/dev/null; then $SUDO pacman -S --noconfirm "$@"
  elif command -v zypper &>/dev/null; then $SUDO zypper install -y "$@"
  else
    echo "âŒ  No supported package manager found." >&2; exit 1
  fi
}

# â”€â”€ base tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for t in curl git unzip; do command -v "$t" &>/dev/null || NEED_BASE=1; done
[[ ${NEED_BASE:-0} == 1 ]] && { echo "ğŸ”§  Installing base toolsâ€¦"; install_pkg curl git ca-certificates unzip; }

# â”€â”€ JetBrains Mono font (prefer Nerd) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FONT_NAME="JetBrainsMono"
NERD_PATTERN="$FONT_NAME.*Nerd Font"

if ! fc-list | grep -qi "$NERD_PATTERN"; then
  echo "â¬‡ï¸  Installing JetBrains Mono from packagesâ€¦"
  case 1 in
    $(command -v pacman >/dev/null 2>&1 && echo 1)) install_pkg ttf-jetbrains-mono-nerd ;;
    $(command -v apt-get >/dev/null 2>&1 && echo 1)) install_pkg fonts-jetbrains-mono   ;;
    $(command -v dnf     >/dev/null 2>&1 && echo 1)) install_pkg jetbrains-mono-fonts  ;;
    $(command -v zypper  >/dev/null 2>&1 && echo 1)) install_pkg jetbrains-mono-fonts  ;;
  esac

  if fc-list | grep -qi "$NERD_PATTERN"; then
    echo "âœ… JetBrains Mono Nerd Font installed!"
  else
    echo "âš ï¸  Repo only had regular JetBrains Mono. Install Nerd Font manually for icons."
  fi
else
  echo "âœ… JetBrains Mono Nerd Font already present"
fi

# â”€â”€ Starship prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v starship &>/dev/null; then
  echo "â¬‡ï¸  Installing Starshipâ€¦"
  if   command -v apt-get &>/dev/null; then install_pkg starship
  elif command -v dnf     &>/dev/null; then install_pkg starship
  elif command -v pacman  &>/dev/null; then install_pkg starship
  elif command -v zypper  &>/dev/null; then install_pkg starship
  else
    curl -sSL https://starship.rs/install.sh | sh -s -- -y
  fi
fi

# â”€â”€ Fish shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
command -v fish &>/dev/null || { echo "â¬‡ï¸  Installing Fish shellâ€¦"; install_pkg fish; }

# â”€â”€ Nushell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v nu &>/dev/null; then
  echo "â¬‡ï¸  Installing Nushellâ€¦"
  if command -v cargo &>/dev/null; then
    cargo install nu
  else
    install_pkg nushell || echo "âš ï¸  Nushell package unavailable; install manually." >&2
  fi
fi

# â”€â”€ Set Nushell as login shell (opt-out with KEEP_CURRENT_SHELL) â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "${KEEP_CURRENT_SHELL:-0}" != 1 ]] && command -v nu &>/dev/null \
   && [[ "$SHELL" != "$(command -v nu)" ]]; then
  NU_PATH=$(command -v nu)
  grep -q "$NU_PATH" /etc/shells || echo "$NU_PATH" | $SUDO tee -a /etc/shells >/dev/null
  $SUDO chsh -s "$NU_PATH"
  echo "âš™ï¸  Nushell set as default. Log out & back in to activate."
fi
{{ end -}}

{{ if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env bash
# Install JetBrains Mono Nerd Font, Starship, Fish & Nushell on macOS
# Nushell becomes login shell unless KEEP_CURRENT_SHELL=1.
set -euo pipefail

# â”€â”€ root/sudo detection (rare on macOS but kept for symmetry) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ $EUID -eq 0 ]]; then SUDO=""; else SUDO="sudo"; fi

# â”€â”€ JetBrains Mono Nerd Font â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! ls "$HOME/Library/Fonts"/*JetBrainsMono*Nerd*.ttf &>/dev/null 2>&1; then
  echo "â¬‡ï¸  Installing JetBrains Mono Nerd Fontâ€¦"
  if command -v brew &>/dev/null; then
    brew tap homebrew/cask-fonts
    brew install --cask font-jetbrains-mono-nerd-font
  else
    echo "âš ï¸  Homebrew not found. Install the font manually." >&2
  fi
fi

# â”€â”€ Starship prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v starship &>/dev/null; then
  echo "â¬‡ï¸  Installing Starshipâ€¦"
  command -v brew &>/dev/null && brew install starship \
    || curl -sSL https://starship.rs/install.sh | sh -s -- -y
fi

# â”€â”€ Fish shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v fish &>/dev/null; then
  echo "â¬‡ï¸  Installing Fish shellâ€¦"
  command -v brew &>/dev/null && brew install fish \
    || echo "âš ï¸  Install Homebrew or Fish manually." >&2
fi

# â”€â”€ Nushell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v nu &>/dev/null; then
  echo "â¬‡ï¸  Installing Nushellâ€¦"
  command -v brew &>/dev/null && brew install nushell \
    || echo "âš ï¸  Install Homebrew or Nushell manually." >&2
fi

# â”€â”€ Set Nushell as login shell (opt-out) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "${KEEP_CURRENT_SHELL:-0}" != 1 ]] && command -v nu &>/dev/null \
   && [[ "$SHELL" != "$(command -v nu)" ]]; then
  NU_PATH=$(command -v nu)
  grep -q "$NU_PATH" /etc/shells || echo "$NU_PATH" | $SUDO tee -a /etc/shells >/dev/null
  $SUDO chsh -s "$NU_PATH"
  echo "âš™ï¸  Nushell set as default. Log out & back in to activate."
fi
{{ end -}}
