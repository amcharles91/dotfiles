{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# Install JetBrainsMono Nerd Font, Starship, Fish and Nushell on Linux
set -e

install_pkg() {
  if command -v apt-get &>/dev/null; then
    sudo apt-get install -y "$@"
  elif command -v dnf &>/dev/null; then
    sudo dnf install -y "$@"
  elif command -v pacman &>/dev/null; then
    sudo pacman -S --noconfirm "$@"
  elif command -v zypper &>/dev/null; then
    sudo zypper install -y "$@"
  else
    echo "No supported package manager found."; exit 1
  fi
}

# ── unzip ────────────────────────────────────────────────────────────────
if ! command -v unzip &>/dev/null; then
  echo "Installing unzip…"
  install_pkg unzip
fi

FONT_NAME="JetBrainsMono"
FONT_DIR="$HOME/.local/share/fonts"
FONT_URL="https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/JetBrainsMono.zip"

# ── JetBrainsMono Nerd Font ──────────────────────────────────────────────
if fc-list | grep -qi "$FONT_NAME.*Nerd Font"; then
  echo "JetBrainsMono Nerd Font already installed"
else
  echo "Installing JetBrainsMono Nerd Font…"
  if command -v apt-get &>/dev/null;   then sudo apt-get update -qq && sudo apt-get install -y fonts-jetbrains-mono || :
  elif command -v dnf &>/dev/null;     then sudo dnf install -y jetbrains-mono-fonts        || :
  elif command -v pacman &>/dev/null;  then sudo pacman -S --noconfirm ttf-jetbrains-mono-nerd || :
  elif command -v zypper &>/dev/null;  then sudo zypper install -y jetbrains-mono-fonts      || :
  fi

  if ! fc-list | grep -qi "$FONT_NAME.*Nerd Font"; then
    echo "Manual Nerd Font install…"
    mkdir -p "$FONT_DIR"
    tmp=$(mktemp -d); trap 'rm -rf "$tmp"' EXIT
    curl -fLo "$tmp/font.zip" "$FONT_URL"
    unzip -q "$tmp/font.zip" -d "$tmp"
    find "$tmp" -name "*.ttf" -exec cp {} "$FONT_DIR/" \;
    fc-cache -fv
  fi
  echo "JetBrainsMono Nerd Font installed!"
fi

# ── Starship ─────────────────────────────────────────────────────────────
if ! command -v starship &>/dev/null; then
  echo "Installing Starship…"
  curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# ── Fish shell ───────────────────────────────────────────────────────────
if ! command -v fish &>/dev/null; then
  echo "Installing Fish shell…"
  install_pkg fish
fi

# ── Nushell ──────────────────────────────────────────────────────────────
if ! command -v nu &>/dev/null; then
  echo "Installing Nushell…"
  if command -v cargo &>/dev/null; then
    cargo install nu
  else
    NU_VERSION="0.91.0"
    ARCH=$(uname -m)
    case "$ARCH" in
      x86_64|aarch64) ;;
      *) echo "Unsupported arch: $ARCH"; exit 1 ;;
    esac
    curl -fLo /tmp/nu.tar.gz \
      "https://github.com/nushell/nushell/releases/download/$NU_VERSION/nu-$NU_VERSION-$ARCH-unknown-linux-musl.tar.gz"
    sudo mkdir -p /usr/local/bin
    sudo tar -xzf /tmp/nu.tar.gz -C /usr/local/bin --strip-components=1 \
      nu-$NU_VERSION-$ARCH-unknown-linux-musl/nu
    rm /tmp/nu.tar.gz
  fi
fi

# ── Default shell switch (optional) ──────────────────────────────────────
if command -v nu &>/dev/null && [ "$SHELL" != "$(which nu)" ]; then
  echo "Setting Nu as default shell…"
  NU_PATH=$(which nu)
  if ! grep -q "$NU_PATH" /etc/shells; then
    echo "$NU_PATH" | sudo tee -a /etc/shells
  fi
  chsh -s "$NU_PATH"
  echo "Default shell set to Nu. Log out & in to apply."
fi
{{ end -}}

{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Install JetBrainsMono Nerd Font, Starship, Fish and Nushell on macOS
set -e

FONT_DIR="$HOME/Library/Fonts"
FONT_URL="https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/JetBrainsMono.zip"

# ── JetBrainsMono Nerd Font ──────────────────────────────────────────────
if ls "$FONT_DIR"/*JetBrainsMono*Nerd*.ttf &>/dev/null 2>&1; then
  echo "JetBrainsMono Nerd Font already installed"
else
  echo "Installing JetBrainsMono Nerd Font…"
  if command -v brew &>/dev/null; then
    brew tap homebrew/cask-fonts
    brew install --cask font-jetbrains-mono-nerd-font
  else
    tmp=$(mktemp -d); trap 'rm -rf "$tmp"' EXIT
    curl -fLo "$tmp/font.zip" "$FONT_URL"
    unzip -q "$tmp/font.zip" -d "$tmp"
    find "$tmp" -name "*.ttf" -exec cp {} "$FONT_DIR/" \;
  fi
fi

# ── Starship ─────────────────────────────────────────────────────────────
if ! command -v starship &>/dev/null; then
  echo "Installing Starship…"
  if command -v brew &>/dev/null; then
    brew install starship
  else
    curl -sS https://starship.rs/install.sh | sh -s -- -y
  fi
fi

# ── Fish shell ───────────────────────────────────────────────────────────
if ! command -v fish &>/dev/null; then
  echo "Installing Fish shell…"
  if command -v brew &>/dev/null; then
    brew install fish
  else
    echo "Please install Fish manually or install Homebrew first."
  fi
fi

# ── Nushell ──────────────────────────────────────────────────────────────
if ! command -v nu &>/dev/null; then
  echo "Installing Nushell…"
  if command -v brew &>/dev/null; then
    brew install nushell
  else
    echo "Please install Nushell manually or install Homebrew first."
  fi
fi
{{ end -}}
